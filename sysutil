#!/usr/local/bin/bash

# =============================================================================
# macOS System Utility Script (sysutil)
# =============================================================================
# A comprehensive utility for managing macOS power, processes, and diagnostics.
#
# Usage: sysutil <command> [options]
#
# Author: System Configuration
# Date: 31 January 2026
# Location: ~/bin/sysutil
# =============================================================================

VERSION="1.0.0"

# Colours for output
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
CYAN=$'\033[0;36m'
NC=$'\033[0m' # No Colour

# -----------------------------------------------------------------------------
# Help
# -----------------------------------------------------------------------------
show_help() {
    cat << EOF
${BLUE}macOS System Utility v$VERSION${NC}

${YELLOW}Usage:${NC} sysutil <command> [options]

${YELLOW}Commands:${NC}
  ${GREEN}status${NC}              Show overall system status
  ${GREEN}top${NC}                 Show top CPU-consuming processes
  ${GREEN}thermal${NC}             Show thermal status and CPU throttling
  ${GREEN}assertions${NC}          Show all sleep blockers/assertions
  ${GREEN}throttle${NC}            Manually throttle iCloud/Spotlight processes
  ${GREEN}monitor${NC}             Start live monitoring of throttled processes
  ${GREEN}touchid${NC}             Reset Touch ID daemons (fix after sleep issues)
  ${GREEN}sleep-check${NC}         Check if system can sleep properly
  ${GREEN}sleep-test${NC}          Test sleep/wake cycle
  ${GREEN}icloud-reset${NC}        Reset iCloud sync state (clears caches)
  ${GREEN}icloud-status${NC}       Show iCloud sync status and orphaned containers
  ${GREEN}spotlight${NC}           Control Spotlight indexing (on/off/status)
  ${GREEN}audio${NC}               Check audio-related sleep assertions
  ${GREEN}battery${NC}             Show battery status and health
  ${GREEN}wake-reason${NC}         Show recent wake reasons
  ${GREEN}pmset${NC}               Show current power management settings

${YELLOW}Options:${NC}
  -h, --help          Show this help message
  -v, --version       Show version

${YELLOW}Examples:${NC}
  sysutil status              # Quick system health check
  sysutil throttle            # Manually renice iCloud/Spotlight
  sysutil touchid             # Fix Touch ID after sleep
  sysutil monitor             # Watch throttled processes live
  sysutil spotlight off       # Disable Spotlight indexing
  sysutil spotlight on        # Enable Spotlight indexing
  sysutil sleep-check         # Verify sleep configuration
  sysutil wake-reason         # See what woke the Mac

EOF
}

# -----------------------------------------------------------------------------
# Status Command
# -----------------------------------------------------------------------------
cmd_status() {
    echo -e "${BLUE}╔═══════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║         System Status Overview            ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════╝${NC}"
    echo ""
    
    # Thermal
    echo -e "${YELLOW}▸ Thermal Status${NC}"
    local speed=$(pmset -g therm 2>/dev/null | grep "CPU_Speed_Limit" | awk '{print $3}')
    if [ -z "$speed" ]; then
        speed="unknown"
    fi
    if [ "$speed" = "100" ]; then
        echo -e "  CPU Speed Limit: ${GREEN}${speed}%${NC} (no throttling)"
    elif [ "$speed" != "unknown" ]; then
        echo -e "  CPU Speed Limit: ${RED}${speed}%${NC} (THROTTLED!)"
    else
        echo -e "  CPU Speed Limit: ${YELLOW}${speed}${NC}"
    fi
    echo ""
    
    # Load
    echo -e "${YELLOW}▸ System Load${NC}"
    local load=$(uptime | awk -F'load averages:' '{print $2}' | xargs)
    echo "  Load Averages: $load"
    echo ""
    
    # Power
    echo -e "${YELLOW}▸ Power Status${NC}"
    local power_source=$(pmset -g ps | head -1 | grep -o "'.*'" | tr -d "'")
    local battery=$(pmset -g ps | grep -o "[0-9]*%" | head -1)
    echo "  Source: $power_source"
    [ -n "$battery" ] && echo "  Battery: $battery"
    echo ""
    
    # Sleep blockers
    echo -e "${YELLOW}▸ Sleep Blockers${NC}"
    local prevent_system=$(pmset -g assertions 2>/dev/null | grep "PreventSystemSleep" | head -1 | awk '{print $2}')
    local prevent_idle=$(pmset -g assertions 2>/dev/null | grep "PreventUserIdleSystemSleep" | head -1 | awk '{print $2}')
    
    if [ "$prevent_system" = "0" ] && [ "$prevent_idle" = "0" ]; then
        echo -e "  ${GREEN}✓ No active sleep blockers${NC}"
    else
        [ "$prevent_system" != "0" ] && echo -e "  ${RED}✗ PreventSystemSleep active${NC}"
        [ "$prevent_idle" != "0" ] && echo -e "  ${YELLOW}! PreventUserIdleSystemSleep active${NC}"
        echo "  Run 'sysutil assertions' for details"
    fi
    echo ""
    
    # Top processes
    echo -e "${YELLOW}▸ Top CPU Processes${NC}"
    ps aux | sort -nrk 3 | head -5 | awk '{printf "  %-30s %5.1f%%\n", substr($11,1,30), $3}'
    echo ""
    
    # Throttler status
    echo -e "${YELLOW}▸ Throttler Daemon${NC}"
    if pgrep -f "icloud-throttle.sh" >/dev/null 2>&1; then
        echo -e "  ${GREEN}✓ Running${NC}"
    else
        echo -e "  ${RED}✗ Not running${NC}"
    fi
}

# -----------------------------------------------------------------------------
# Top Command
# -----------------------------------------------------------------------------
cmd_top() {
    echo -e "${BLUE}=== Top CPU Processes ===${NC}"
    echo ""
    printf "%-8s %-35s %8s %8s\n" "PID" "PROCESS" "CPU%" "MEM%"
    echo "────────────────────────────────────────────────────────────────"
    ps aux | sort -nrk 3 | head -15 | awk '{printf "%-8s %-35s %8.1f %8.1f\n", $2, substr($11,1,35), $3, $4}'
}

# -----------------------------------------------------------------------------
# Thermal Command
# -----------------------------------------------------------------------------
cmd_thermal() {
    echo -e "${BLUE}=== Thermal Status ===${NC}"
    echo ""
    pmset -g therm
}

# -----------------------------------------------------------------------------
# Assertions Command
# -----------------------------------------------------------------------------
cmd_assertions() {
    echo -e "${BLUE}=== Sleep Assertions ===${NC}"
    echo ""
    pmset -g assertions
}

# -----------------------------------------------------------------------------
# Throttle Command
# -----------------------------------------------------------------------------
cmd_throttle() {
    echo -e "${BLUE}=== Throttling Processes ===${NC}"
    echo ""
    
    local throttled=0
    
    # User processes
    for proc in fileproviderd cloudd bird; do
        local pid=$(pgrep -x "$proc" | head -1)
        if [ -n "$pid" ]; then
            local current=$(ps -o nice= -p "$pid" 2>/dev/null | tr -d ' ')
            if [ "$current" != "20" ]; then
                renice 20 -p "$pid" >/dev/null 2>&1
                echo -e "${GREEN}✓${NC} Throttled $proc (PID: $pid) nice: $current → 20"
                ((throttled++))
            else
                echo -e "${CYAN}○${NC} $proc (PID: $pid) already at nice 20"
            fi
        else
            echo -e "${YELLOW}○${NC} $proc not running"
        fi
    done
    
    # Root processes (need sudo)
    for proc in mds mds_stores; do
        local pid=$(pgrep -x "$proc" | head -1)
        if [ -n "$pid" ]; then
            local current=$(ps -o nice= -p "$pid" 2>/dev/null | tr -d ' ')
            if [ "$current" != "20" ]; then
                sudo renice 20 -p "$pid" >/dev/null 2>&1
                echo -e "${GREEN}✓${NC} Throttled $proc (PID: $pid) nice: $current → 20"
                ((throttled++))
            else
                echo -e "${CYAN}○${NC} $proc (PID: $pid) already at nice 20"
            fi
        else
            echo -e "${YELLOW}○${NC} $proc not running"
        fi
    done
    
    echo ""
    echo "Throttled $throttled process(es)"
}

# -----------------------------------------------------------------------------
# Monitor Command
# -----------------------------------------------------------------------------
cmd_monitor() {
    echo -e "${BLUE}=== Process Monitor (Ctrl+C to stop) ===${NC}"
    echo ""
    
    if [ -f /tmp/icloud-throttle.out ]; then
        tail -f /tmp/icloud-throttle.out
    else
        echo -e "${RED}Throttle daemon log not found${NC}"
        echo "Starting manual monitoring..."
        echo ""
        
        while true; do
            echo "=== $(date '+%H:%M:%S') ==="
            printf "%-20s %8s %8s %8s\n" "PROCESS" "PID" "NICE" "CPU%"
            echo "------------------------------------------------"
            
            for proc in fileproviderd cloudd bird mds mds_stores; do
                local pid=$(pgrep -x "$proc" | head -1)
                if [ -n "$pid" ]; then
                    local nice=$(ps -o nice= -p "$pid" 2>/dev/null | tr -d ' ')
                    local cpu=$(ps -o %cpu= -p "$pid" 2>/dev/null | tr -d ' ')
                    printf "%-20s %8s %8s %8s\n" "$proc" "$pid" "$nice" "$cpu"
                fi
            done
            
            echo ""
            sleep 5
        done
    fi
}

# -----------------------------------------------------------------------------
# Touch ID Command
# -----------------------------------------------------------------------------
cmd_touchid() {
    echo -e "${BLUE}=== Resetting Touch ID ===${NC}"
    echo ""
    
    echo "Killing biometric daemons..."
    sudo killall biometrickitd BiomeAgent biomed TouchBarServer 2>/dev/null
    
    echo "Waiting for restart..."
    sleep 3
    
    if pgrep -x biometrickitd >/dev/null; then
        echo -e "${GREEN}✓${NC} Touch ID daemons restarted successfully"
        echo ""
        echo -e "${YELLOW}Try using Touch ID now (lock screen with Ctrl+Cmd+Q)${NC}"
    else
        echo -e "${RED}✗${NC} Touch ID daemons may not have restarted"
        echo "Try locking the screen to trigger restart"
    fi
}

# -----------------------------------------------------------------------------
# Sleep Check Command
# -----------------------------------------------------------------------------
cmd_sleep_check() {
    echo -e "${BLUE}=== Sleep Readiness Check ===${NC}"
    echo ""
    
    local issues=0
    
    # Check clamshell setting
    local clamshell=$(ioreg -r -k AppleClamshellCausesSleep 2>/dev/null | grep AppleClamshellCausesSleep | awk '{print $3}')
    if [ "$clamshell" = "Yes" ]; then
        echo -e "${GREEN}✓${NC} Lid close will cause sleep"
    else
        echo -e "${RED}✗${NC} Lid close will NOT cause sleep"
        echo "  → SMC reset required"
        ((issues++))
    fi
    
    # Check PreventSystemSleep
    local prevent_system=$(pmset -g assertions 2>/dev/null | grep "PreventSystemSleep" | head -1 | awk '{print $2}')
    if [ "$prevent_system" = "0" ]; then
        echo -e "${GREEN}✓${NC} No PreventSystemSleep assertions"
    else
        echo -e "${RED}✗${NC} PreventSystemSleep is active"
        pmset -g assertions 2>/dev/null | grep -A2 "PreventSystemSleep.*1" | grep "pid" | head -3 | sed 's/^/  → /'
        ((issues++))
    fi
    
    # Check PreventUserIdleSystemSleep
    local prevent_idle=$(pmset -g assertions 2>/dev/null | grep "PreventUserIdleSystemSleep" | head -1 | awk '{print $2}')
    if [ "$prevent_idle" = "0" ]; then
        echo -e "${GREEN}✓${NC} No PreventUserIdleSystemSleep assertions"
    else
        echo -e "${YELLOW}!${NC} PreventUserIdleSystemSleep is active"
        pmset -g assertions 2>/dev/null | grep "PreventUserIdleSystemSleep named" | head -3 | sed 's/^/  → /'
        ((issues++))
    fi
    
    # Check audio assertions
    local audio=$(pmset -g assertions 2>/dev/null | grep -i "audio")
    if [ -z "$audio" ]; then
        echo -e "${GREEN}✓${NC} No audio assertions"
    else
        echo -e "${YELLOW}!${NC} Audio assertions present"
        echo "$audio" | head -3 | sed 's/^/  → /'
        ((issues++))
    fi
    
    # Check sleep setting
    local sleep_setting=$(pmset -g | grep "^ sleep" | awk '{print $2}')
    if [ "$sleep_setting" = "0" ]; then
        local power=$(pmset -g ps | head -1)
        if echo "$power" | grep -q "AC Power"; then
            echo -e "${GREEN}✓${NC} Sleep disabled on AC (as configured)"
        else
            echo -e "${RED}✗${NC} Sleep disabled on battery!"
            ((issues++))
        fi
    else
        echo -e "${GREEN}✓${NC} Sleep enabled (${sleep_setting} min)"
    fi
    
    echo ""
    if [ $issues -eq 0 ]; then
        echo -e "${GREEN}System is ready to sleep properly${NC}"
    else
        echo -e "${YELLOW}$issues issue(s) found - may affect sleep${NC}"
    fi
}

# -----------------------------------------------------------------------------
# Sleep Test Command
# -----------------------------------------------------------------------------
cmd_sleep_test() {
    echo -e "${BLUE}=== Sleep Test ===${NC}"
    echo ""
    echo "This will test sleep/wake by:"
    echo "1. Recording current sleep/wake count"
    echo "2. You close and open the lid"
    echo "3. Verifying sleep occurred"
    echo ""
    
    local before=$(pmset -g log 2>/dev/null | grep "Sleep/Wakes since boot" | tail -1 | grep -o ":[0-9]*" | tail -1 | tr -d ':')
    echo "Current sleep/wake count: $before"
    echo ""
    echo -e "${YELLOW}Close the lid for 10 seconds, then open it${NC}"
    echo "Press Enter when done..."
    read
    
    local after=$(pmset -g log 2>/dev/null | grep "Sleep/Wakes since boot" | tail -1 | grep -o ":[0-9]*" | tail -1 | tr -d ':')
    echo ""
    echo "New sleep/wake count: $after"
    
    if [ "$after" -gt "$before" ] 2>/dev/null; then
        echo -e "${GREEN}✓ Sleep test PASSED${NC}"
        echo ""
        echo "Last sleep/wake events:"
        pmset -g log | grep -E "(Entering|Wake from)" | tail -2
    else
        echo -e "${RED}✗ Sleep test FAILED - system did not sleep${NC}"
        echo "Check 'sysutil sleep-check' for issues"
    fi
}

# -----------------------------------------------------------------------------
# iCloud Reset Command
# -----------------------------------------------------------------------------
cmd_icloud_reset() {
    echo -e "${BLUE}=== Reset iCloud Sync State ===${NC}"
    echo ""
    echo -e "${YELLOW}Warning: This will:${NC}"
    echo "  • Kill iCloud sync processes"
    echo "  • Clear local sync caches"
    echo "  • Force iCloud to rebuild sync database"
    echo ""
    echo "Your files are safe - they exist on Apple's servers."
    echo ""
    read -p "Continue? (y/N) " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo ""
        echo "Killing iCloud processes..."
        killall -9 fileproviderd cloudd bird 2>/dev/null
        
        echo "Clearing sync caches..."
        rm -rf ~/Library/Application\ Support/CloudDocs/session/ 2>/dev/null
        rm -rf ~/Library/Caches/CloudKit/ 2>/dev/null
        rm -rf ~/Library/Caches/com.apple.bird/ 2>/dev/null
        
        echo ""
        echo -e "${GREEN}✓ iCloud sync state reset${NC}"
        echo ""
        echo "iCloud will now rebuild its sync database."
        echo "Monitor with: sysutil monitor"
    else
        echo "Cancelled"
    fi
}

# -----------------------------------------------------------------------------
# iCloud Status Command
# -----------------------------------------------------------------------------
cmd_icloud_status() {
    echo -e "${BLUE}=== iCloud Status ===${NC}"
    echo ""
    
    echo -e "${YELLOW}▸ iCloud Processes${NC}"
    for proc in fileproviderd cloudd bird; do
        local pid=$(pgrep -x "$proc" | head -1)
        if [ -n "$pid" ]; then
            local cpu=$(ps -o %cpu= -p "$pid" 2>/dev/null | tr -d ' ')
            local nice=$(ps -o nice= -p "$pid" 2>/dev/null | tr -d ' ')
            printf "  %-20s PID: %-8s CPU: %5.1f%%  Nice: %s\n" "$proc" "$pid" "$cpu" "$nice"
        else
            printf "  %-20s (not running)\n" "$proc"
        fi
    done
    echo ""
    
    echo -e "${YELLOW}▸ iCloud Drive Size${NC}"
    local size=$(du -sh ~/Library/Mobile\ Documents/ 2>/dev/null | awk '{print $1}')
    echo "  Local: $size"
    echo ""
    
    echo -e "${YELLOW}▸ Orphaned Containers${NC}"
    local orphaned=$(brctl status 2>/dev/null | grep -c "app not installed" 2>/dev/null || echo "0")
    if [ "$orphaned" -gt 0 ]; then
        echo -e "  ${YELLOW}$orphaned orphaned container(s)${NC}"
    else
        echo -e "  ${GREEN}No orphaned containers${NC}"
    fi
}

# -----------------------------------------------------------------------------
# Spotlight Command
# -----------------------------------------------------------------------------
cmd_spotlight() {
    local action="$1"
    
    case "$action" in
        on)
            echo -e "${BLUE}Enabling Spotlight...${NC}"
            sudo mdutil -a -i on
            echo -e "${GREEN}✓ Spotlight indexing enabled${NC}"
            ;;
        off)
            echo -e "${BLUE}Disabling Spotlight...${NC}"
            sudo mdutil -a -i off
            echo -e "${GREEN}✓ Spotlight indexing disabled${NC}"
            ;;
        status|"")
            echo -e "${BLUE}=== Spotlight Status ===${NC}"
            echo ""
            mdutil -s /
            echo ""
            echo -e "${YELLOW}▸ Spotlight Processes${NC}"
            for proc in mds mds_stores; do
                local pid=$(pgrep -x "$proc" | head -1)
                if [ -n "$pid" ]; then
                    local cpu=$(ps -o %cpu= -p "$pid" 2>/dev/null | tr -d ' ')
                    local nice=$(ps -o nice= -p "$pid" 2>/dev/null | tr -d ' ')
                    printf "  %-20s PID: %-8s CPU: %5.1f%%  Nice: %s\n" "$proc" "$pid" "$cpu" "$nice"
                fi
            done
            ;;
        *)
            echo -e "${RED}Unknown action: $action${NC}"
            echo "Usage: sysutil spotlight [on|off|status]"
            ;;
    esac
}

# -----------------------------------------------------------------------------
# Audio Command
# -----------------------------------------------------------------------------
cmd_audio() {
    echo -e "${BLUE}=== Audio Sleep Assertions ===${NC}"
    echo ""
    
    local audio=$(pmset -g assertions 2>/dev/null | grep -i "audio\|coreaudio\|sound")
    
    if [ -z "$audio" ]; then
        echo -e "${GREEN}✓ No audio-related sleep assertions${NC}"
    else
        echo -e "${YELLOW}Audio assertions found:${NC}"
        echo "$audio" | sed 's/^/  /'
    fi
    
    echo ""
    echo -e "${YELLOW}▸ Audio Drivers Loaded${NC}"
    ls -la /Library/Audio/Plug-Ins/HAL/ 2>/dev/null | grep "\.driver" | awk '{print "  " $NF}'
    
    echo ""
    echo -e "${YELLOW}▸ coreaudiod Status${NC}"
    local pid=$(pgrep -x coreaudiod | head -1)
    if [ -n "$pid" ]; then
        local cpu=$(ps -o %cpu= -p "$pid" 2>/dev/null | tr -d ' ')
        echo "  PID: $pid  CPU: ${cpu}%"
    fi
}

# -----------------------------------------------------------------------------
# Battery Command
# -----------------------------------------------------------------------------
cmd_battery() {
    echo -e "${BLUE}=== Battery Status ===${NC}"
    echo ""
    
    pmset -g ps
    echo ""
    
    echo -e "${YELLOW}▸ Battery Health${NC}"
    system_profiler SPPowerDataType 2>/dev/null | grep -E "Cycle Count|Condition|Charge Remaining|Full Charge Capacity" | sed 's/^/  /'
}

# -----------------------------------------------------------------------------
# Wake Reason Command
# -----------------------------------------------------------------------------
cmd_wake_reason() {
    echo -e "${BLUE}=== Recent Wake Reasons ===${NC}"
    echo ""
    
    pmset -g log | grep -E "Wake from|Wake reason|DarkWake" | tail -15
}

# -----------------------------------------------------------------------------
# PMSet Command
# -----------------------------------------------------------------------------
cmd_pmset() {
    echo -e "${BLUE}=== Power Management Settings ===${NC}"
    echo ""
    pmset -g custom
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------
case "$1" in
    status)
        cmd_status
        ;;
    top)
        cmd_top
        ;;
    thermal)
        cmd_thermal
        ;;
    assertions)
        cmd_assertions
        ;;
    throttle)
        cmd_throttle
        ;;
    monitor)
        cmd_monitor
        ;;
    touchid)
        cmd_touchid
        ;;
    sleep-check)
        cmd_sleep_check
        ;;
    sleep-test)
        cmd_sleep_test
        ;;
    icloud-reset)
        cmd_icloud_reset
        ;;
    icloud-status)
        cmd_icloud_status
        ;;
    spotlight)
        cmd_spotlight "$2"
        ;;
    audio)
        cmd_audio
        ;;
    battery)
        cmd_battery
        ;;
    wake-reason)
        cmd_wake_reason
        ;;
    pmset)
        cmd_pmset
        ;;
    -v|--version)
        echo "sysutil version $VERSION"
        ;;
    -h|--help|"")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'sysutil --help' for usage"
        exit 1
        ;;
esac
